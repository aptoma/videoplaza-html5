/*! videoplaza-html5 - v0.1.8 - 2013-03-20
* https://github.com/aptoma/videoplaza-html5
* Copyright (c) 2013 Aptoma AS; Licensed MIT */
function VideoplazaAds(t,e){this.vpHost=t,this.requestSettings={width:null,height:null,bitrate:null,insertionPointType:null,playbackPosition:null},this.adPlaying=!1,this.adsEnabled=!0,this.midrolls=[],this.lastPlayedMidroll=null,this.debug=!!e,this.skipHandler={start:null,end:null},this._playerState={originalSrc:null,timeToResume:0,ended:!1},this.takeoverCallbacks={onTakeover:null,onRelease:null},this._clickEvent=navigator.userAgent.match(/iPad/i)?"touchstart":"click",this._isAppleDevice=navigator.userAgent.match(/iPad|iPod|iPhone/i),this._bindContextForCallbacks(),this.adCall=new videoplaza.core.AdCallModule(t),this.tracker=new videoplaza.core.Tracker,this.trackingEvents=videoplaza.core.Tracker.trackingEvents}VideoplazaAds.prototype.log=function(){this.debug&&console.log&&console.log.apply&&console.log.apply(console,arguments)},VideoplazaAds.prototype.logError=function(){console.error&&console.error.apply?console.error.apply(console,arguments):this.log.apply(arguments)},VideoplazaAds.prototype.setSkipHandler=function(t,e){this.skipHandler.start=t,this.skipHandler.end=e},VideoplazaAds.prototype.setTakeoverCallbacks=function(t,e){this.takeoverCallbacks.onTakeover=t,this.takeoverCallbacks.onRelease=e},VideoplazaAds.prototype.skipCurrentAd=function(){this._showNextAd()},VideoplazaAds.prototype.setAdsEnabled=function(t){this.adsEnabled=t},VideoplazaAds.prototype.setCompanionHandler=function(t){this.companionHandler=t},VideoplazaAds.prototype.setMidrolls=function(t){typeof t==typeof[]&&t.sort(function(t,e){return t-e}),this.midrolls=t,this.lastPlayedMidroll=null},VideoplazaAds.prototype.setContentMeta=function(t){this.contentMeta=t},VideoplazaAds.prototype.setVideoProperties=function(t,e,i){this.requestSettings.width=t,this.requestSettings.height=e,this.requestSettings.bitrate=i},VideoplazaAds.prototype._needControls=function(){return navigator.userAgent.match(/iPad|iPod|iPhone|Android/)},VideoplazaAds.prototype._bindContextForCallbacks=function(){this._onAdPlay=this._onAdPlay.bind(this),this._onAdCanPlay=this._onAdCanPlay.bind(this),this._onAdClick=this._onAdClick.bind(this),this._onAdClickToResume=this._onAdClickToResume.bind(this),this._onAdTick=this._onAdTick.bind(this),this._showNextAd=this._showNextAd.bind(this),this._onAdError=this._onAdError.bind(this),this._checkForPreroll=this._checkForPreroll.bind(this),this._checkForMidroll=this._checkForMidroll.bind(this),this._checkForPostroll=this._checkForPostroll.bind(this),this._onVideoCanPlay=this._onVideoCanPlay.bind(this)},VideoplazaAds.prototype._listen=function(t,e,i){t.addEventListener(e,i,!1)},VideoplazaAds.prototype._unlisten=function(t,e,i){t.removeEventListener(e,i,!1)},VideoplazaAds.prototype._takeover=function(){this.log("take over player"),this.player.controls=!1,this._listen(this.player,"play",this._onAdPlay),this._listen(this.player,this._clickEvent,this._onAdClick),this._listen(this.player,"canplay",this._onAdCanPlay),this._listen(this.player,"timeupdate",this._onAdTick),this._listen(this.player,"ended",this._showNextAd),this._listen(this.player,"error",this._onAdError),this._unlisten(this.player,"canplay",this._onVideoCanPlay),this._unlisten(this.player,"play",this._checkForPreroll),this._unlisten(this.player,"timeupdate",this._checkForMidroll),this._unlisten(this.player,"ended",this._checkForPostroll),"function"==typeof this.takeoverCallbacks.onTakeover&&this.takeoverCallbacks.onTakeover(this.player)},VideoplazaAds.prototype._release=function(){this.log("release player"),this.player.controls=!0,this._unlisten(this.player,"play",this._onAdPlay),this._unlisten(this.player,this._clickEvent,this._onAdClick),this._unlisten(this.player,this._clickEvent,this._onAdClickToResume),this._unlisten(this.player,"canplay",this._onAdCanPlay),this._unlisten(this.player,"timeupdate",this._onAdTick),this._unlisten(this.player,"ended",this._showNextAd),this._listen(this.player,"canplay",this._onVideoCanPlay),this._listen(this.player,"play",this._checkForPreroll),this._listen(this.player,"timeupdate",this._checkForMidroll),this._listen(this.player,"ended",this._checkForPostroll),"function"==typeof this.takeoverCallbacks.onRelease&&this.takeoverCallbacks.onRelease(this.player)},VideoplazaAds.prototype._onAdsReceived=function(t){this.log("got ads",t),this.ads=t,this.adIndex=-1,this._showNextAd()},VideoplazaAds.prototype._showNextAd=function(){if(this.adPlaying=!1,this.adIndex++,!this.adsEnabled||this.adIndex>=this.ads.length)return this.log("no more ads"),"function"==typeof this.skipHandler.end&&this.skipHandler.end.call(this),this._resumeOriginalVideo(),!1;switch(this.log("showing ad #"+this.adIndex),this.ad=this.ads[this.adIndex],this.ad.type){case"standard_spot":return this.log("found standard spot"),this._displayAdCreatives(this.ad.creatives),!0;case"inventory":return this.log("found inventory"),this.tracker.track(this.ad,this.trackingEvents.ad.impression),this._showNextAd();default:return this._onVideoplazaError("ad format "+this.ad.type+" not supported"),!1}},VideoplazaAds.prototype._showCompanionBanner=function(t){if(this.log("show companion banner",t),"function"!=typeof this.companionHandler)return!1;var e='<iframe scrolling="no" frameborder="0" width="'+t.width+'" '+'height="'+t.height+'" '+'src="'+t.resource+'"></iframe>';return this.companionHandler(e,t.zoneId,t.width,t.height)?(this.tracker.track(t,this.trackingEvents.creative.creativeView),!0):!1},VideoplazaAds.prototype._displayAdCreatives=function(t){this.adVideo=null,this.log("found "+t.length+" creatives for ad");for(var e=0,i=t.length;i>e;e++)"video"===t[e].id?(this.log("found video creative",t[e]),this.adVideo=t[e]):"companion"===t[e].type&&(this.log("found companion creative",t[e]),this._showCompanionBanner(t[e])||this.logError("Videoplaza error: no way of displaying companion ad"));return this.adVideo?(this._playVideoAd(),void 0):(this.logError("Videoplaza error: bad ad - no video",this.ad),this._showNextAd(),void 0)},VideoplazaAds.prototype._onVideoplazaError=function(t){this.logError("Videoplaza error: "+t),this._resumeOriginalVideo()},VideoplazaAds.prototype._runAds=function(t,e){this.player.pause(),this._prepareAdPlayback(),this.requestSettings.insertionPointType=t,this.requestSettings.playbackPosition=e?this.player.currentTime:null;var i=this._onAdsReceived.bind(this),s=this._onVideoplazaError.bind(this);this.adCall.requestAds(this.contentMeta,this.requestSettings,i,s)},VideoplazaAds.prototype._onAdPlay=function(){this.adPlaying?(this.log("ad resumed"),this.tracker.track(this.adVideo,this.trackingEvents.creative.resume)):(this.log("ad started playing"),this.tracker.track(this.ad,this.trackingEvents.ad.impression),this.tracker.track(this.adVideo,this.trackingEvents.creative.creativeView),this.tracker.track(this.adVideo,this.trackingEvents.creative.start)),this.adPlaying=!0},VideoplazaAds.prototype._onAdClick=function(t){return this.log("ad click through to "+this.adVideo.clickThroughUri),this.tracker.track(this.adVideo,this.trackingEvents.creative.clickThrough),window.open(this.adVideo.clickThroughUri,"_blank"),this.player.controls=!0,this.player.pause(),this._unlisten(this.player,this._clickEvent,this._onAdClick),this._listen(this.player,this._clickEvent,this._onAdClickToResume),t.preventDefault(),!1},VideoplazaAds.prototype._onAdTick=function(){if(!(this.player&&this.adVideo&&this.adPlaying))return this.log("Player or ad video not ready"),!1;var t=this.player.currentTime/this.adVideo.duration;if(this.unsentQuartiles.length&&t>this.unsentQuartiles[0]){var e=this.unsentQuartiles.shift();switch(e){case.25:this.log("logged first quartile"),this.tracker.track(this.adVideo,this.trackingEvents.creative.firstQuartile);break;case.5:this.log("logged midpoint"),this.tracker.track(this.adVideo,this.trackingEvents.creative.midpoint);break;case.75:this.log("logged third quartile"),this.tracker.track(this.adVideo,this.trackingEvents.creative.thirdQuartile);break;case.99:this.log("logged last quartile"),this.tracker.track(this.adVideo,this.trackingEvents.creative.complete)}}return!0},VideoplazaAds.prototype._prepareAdPlayback=function(){return this.log("told to create ad player"),this.adPlaying?!1:this.player?(this.log("actually created ad player"),null!==this._playerState.originalSrc&&this.log("Player state has src set",this._playerState.originalSrc,this.player.currentSrc),this._playerState.originalSrc=this.player.currentSrc,this._playerState.timeToResume=this.player.currentTime,this._playerState.ended=this.player.ended,this.log("saved state",this._playerState,this.player.currentTime),this._takeover(),this.adPlaying=!1,!0):!1},VideoplazaAds.prototype._onAdError=function(t){if(t.target.error)switch(t.target.error.code){case t.target.error.MEDIA_ERR_ABORTED:this.logError("Ad playback aborted.");break;case t.target.error.MEDIA_ERR_NETWORK:this.logError("A network error caused the video download to fail part-way");break;case t.target.error.MEDIA_ERR_DECODE:this.logError("The video playback was aborted due to a corruption problem or because the video used features your browser did not support");break;case t.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:this.logError("The video could not be loaded, either because the server or network failed or because the format is not supported");break;default:this.logError("An unknown error occurred")}this._showNextAd()},VideoplazaAds.prototype._playVideoAd=function(){this.log("playing ad",this.adVideo),this.unsentQuartiles=[.25,.5,.75,.99],"function"==typeof this.skipHandler.start&&this.skipHandler.start.call(this,this.adVideo.duration),this.player.setAttribute("src",this.adVideo.mediaFiles[0].uri),this.player.load()},VideoplazaAds.prototype._onAdCanPlay=function(){this.player.play(),this.player.currentTime=0},VideoplazaAds.prototype._onAdClickToResume=function(){this.log("-- click to resume"),this.player.play()},VideoplazaAds.prototype._onVideoCanPlay=function(){return this._playerState.ended&&this._isAppleDevice?(this.player.pause(),void 0):0===this._playerState.timeToResume||null===this._playerState.timeToResume?(this.player.play(),void 0):(this._playerState.isBuffering||this.player.play(),0===this.player.seekable.length||this.player.seekable.end(0)<this._playerState.timeToResume?(this.player.pause(),this._playerState.isBuffering=!0,setTimeout(this._onVideoCanPlay,200),void 0):(this.player.currentTime=this._playerState.timeToResume,this.player.play(),this._playerState.isBuffering=!1,this._playerState.timeToResume=0,void 0))},VideoplazaAds.prototype._resumeOriginalVideo=function(){this.log("resuming watched player",this._playerState),this.player&&!this._playerState.ended&&(this.player.src!==this._playerState.originalSrc&&this._playerState.originalSrc?(this.player.src=this._playerState.originalSrc,this.player.load()):this.player.play()),this.adPlaying=!1,this._release(),this._playerState.ended&&(this.player.autoplay=!1,this.player.src!==this._playerState.originalSrc&&(this.player.src=this._playerState.originalSrc),this._triggerVideoEvent("ended"))},VideoplazaAds.prototype._triggerVideoEvent=function(t){if(this.player){var e;e=document.createEvent("HTMLEvents"),e.initEvent(t,!0,!0),this.player.dispatchEvent(e)}},VideoplazaAds.prototype._checkForPreroll=function(){this.hasShownPreroll||(this._runAds("onBeforeContent"),this.hasShownPreroll=!0)},VideoplazaAds.prototype._checkForMidroll=function(){if(this.adPlaying)return!1;if(0===this.midrolls.length)return!1;for(var t=null,e=0,i=this.midrolls.length;i>e&&!(this.midrolls[e]>this.player.currentTime);e++)t=e;return null!==t&&t!==this.lastPlayedMidroll?(this.log("playing overdue midroll "+t),this.lastPlayedMidroll=t,this._runAds("playbackPosition",!0),!0):!1},VideoplazaAds.prototype._checkForPostroll=function(){this.hasShownPostroll||(this.hasShownPostroll=!0,this._runAds("onContentEnd"))},VideoplazaAds.prototype.watchPlayer=function(t){return this.log("told to watch player",t),"video"!==t.tagName.toLowerCase()?(this.logError("not watching player - not a video element"),!1):(this.player=t,this.hasShownPreroll=!1,this.hasShownPostroll=!1,this.player.paused||(this._runAds("onBeforeContent"),this.hasShownPreroll=!0),this._listen(this.player,"play",this._checkForPreroll),this._listen(this.player,"timeupdate",this._checkForMidroll),this._listen(this.player,"ended",this._checkForPostroll),!0)},Function.prototype.bind===void 0&&(Function.prototype.bind=function(){var t=this,e=Array.prototype.slice.call(arguments),i=e.shift();return function(){var s=e.concat(Array.prototype.slice.call(arguments));return this!==window&&s.push(this),t.apply(i,s)}});